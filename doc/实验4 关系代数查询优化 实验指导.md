# 实验 4 关系代数查询优化 实验指导

关系代数语法树的数据结构主要定义在include/sra.h中.
## 4.1 关系运算类型SRAType
dongmendb定义了以下类型的关系代数操作，但在物理层并没有完全实现这些操作。

```c
enum SRAType {
    SRA_TABLE, /*数据表*/
    SRA_PROJECT, /*投影*/
    SRA_SELECT, /选择*/
    SRA_NATURAL_JOIN,  /*自然连接*/
    SRA_JOIN,  /*theta连接*/
    SRA_FULL_OUTER_JOIN, /*全外连接*/
    SRA_LEFT_OUTER_JOIN, /*左外连接*/
    SRA_RIGHT_OUTER_JOIN, /*右外连接*/
    SRA_UNION, /*集合并*/
    SRA_EXCEPT, /*集合差*/
    SRA_INTERSECT /*集合交*/
};
```

## 4.2 关系代数语法树的数据结构SRA_s

采用递归定义的方式构造了一颗树。

```c
struct SRA_s {
    enum SRAType t;  /*当前关系运算的类型*/
    union {
        SRA_Table_t table;
        SRA_Project_t project;
        SRA_Select_t select;
        SRA_Join_t join;
        SRA_Binary_t binary;
    };
};
```

除SRA_Table_t之外的关系运算都定义了操作的输入，因此是递归定义的。

以select和join操作的定义为例，请看注释。

```c
typedef struct SRA_Select_s {
    SRA_t *sra;  /*select运算的输入*/
    Expression *cond;
} SRA_Select_t;

typedef struct SRA_Join_s {
    SRA_t *sra1, *sra2;  /*join运算的两个输入*/
    JoinCondition_t *opt_cond;
} SRA_Join_t;
```

## 4.3 关系代数语法树的优化过程

对SRA_t按照以下算法进行优化：

1）对 SRA_SELECT 操作进行串接，即把and逻辑运算符连接的多个条件变成多个SRA_SELECT；

2）对 SRA_SELECT 操作和 SRA_JOIN 操作进行等价交换；

3）把每个 SRA_SELECT 交换至最优位置。

## 4.4 代码实现位置
实现src_experiment\exp_05_algebra_opt\exp_05_02_condition_push_down.c中的dongmengdb_algebra_optimize_condition_pushdown函数。

可以使用.optimizer <sql语句>进行测试。


---

